/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[18],{254:function(e,t,a){"use strict";a.d(t,"a",(function(){return o}));var s=a(154);function o(e,t,a){const o=["kuery"===t.language?Object(s.f)(Object(s.d)(t.query)):Object(s.e)(t.query)],r=[];for(const t of e){if(t.meta.disabled||void 0!==a&&t.meta.controlledBy===a)continue;const{meta:{negate:e,type:s,key:i}}=t;let n=t.query;void 0===n&&"exists"===s&&(n={exists:{field:i}}),n&&(e?r.push(n):o.push(n))}return{bool:{must:o,must_not:r}}}},255:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var s=a(23),o=a(25),r=a(8),i=a(26);function n(e,t,a){return e.pipe(Object(o.pluck)("jobIds"),Object(o.distinctUntilChanged)(r.isEqual),Object(o.switchMap)((e=>t.getJobs$(e))),Object(o.map)((e=>e.map((e=>{const t=Object(i.a)(e.analysis_config.bucket_span);return{id:e.job_id,selected:!0,bucketSpanSeconds:t.asSeconds()}})))),Object(o.catchError)((e=>{var t;return a(null!==(t=e.body)&&void 0!==t?t:e),Object(s.of)(void 0)})))}},818:function(e,t,a){"use strict";a.r(t),a.d(t,"EmbeddableAnomalyChartsContainer",(function(){return w}));var s=a(15),o=a.n(s),r=a(40),i=a(41),n=a(8),c=a(23),l=a(25),d=a(101),u=a(43),b=a(99),m=a(78),j=a(254),O=a(255);var h=a(71),g=a.n(h),f=a(2),p=a(369),v=a(130),x=a(11);const y=f.i18n.translate("xpack.ml.explorer.charts.dashboardTooManyBucketsDescription",{defaultMessage:"This selection contains too many buckets to be displayed. You should shorten the time range of the view."}),S=({id:e,chartsData:t,showCharts:a,severity:s,setSeverity:n,mlLocator:c,timeBuckets:l,timefilter:d,onSelectEntity:u,showSelectedInterval:b})=>Object(x.jsx)(o.a.Fragment,null,Object(x.jsx)(r.EuiFlexGroup,{id:e,direction:"row",gutterSize:"l",responsive:!0},Object(x.jsx)(r.EuiFlexItem,{grow:!1},Object(x.jsx)(v.b,{severity:s,onChange:n}))),Object(x.jsx)(r.EuiSpacer,{size:"m"}),Array.isArray(t.seriesToPlot)&&0===t.seriesToPlot.length&&void 0===t.errorMessages&&Object(x.jsx)(r.EuiText,{textAlign:"center","data-test-subj":"mlNoMatchingAnomaliesMessage"},Object(x.jsx)("h4",null,Object(x.jsx)(i.FormattedMessage,{id:"xpack.ml.explorer.noMatchingAnomaliesFoundTitle",defaultMessage:"No matching anomalies found"}))),Object(x.jsx)("div",{className:"euiText explorer-charts"},a&&Object(x.jsx)(p.a,g()({},t,{severity:s.val,mlLocator:c,timeBuckets:l,timefilter:d,onSelectEntity:u,tooManyBucketsCalloutMsg:y,showSelectedInterval:b}))));var E=a(0),T=a(16),M=a(28),A=a(249);const w=({id:e,embeddableContext:t,embeddableInput:a,services:o,refresh:h,onInputChange:g,onOutputChange:f})=>{var p;const[y,w]=Object(s.useState)(0),[I,_]=Object(s.useState)(Object(v.c)(null!==(p=t.getInput().severityThreshold)&&void 0!==p?p:T.ANOMALY_THRESHOLD.WARNING)),[k,R]=Object(s.useState)(),[{uiSettings:C},{data:F,share:B,uiActions:L}]=o,{timefilter:G}=F.query.timefilter,D=Object(s.useMemo)((()=>B.url.locators.get(E.a)),[B]),N=Object(s.useMemo)((()=>new d.a({"histogram:maxBars":C.get(M.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":C.get(M.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:C.get("dateFormat"),"dateFormat:scaled":C.get("dateFormat:scaled")})),[]);Object(s.useEffect)((()=>{g({severityThreshold:I.val}),f({severity:I.val,entityFields:k})}),[I,k]);const{chartsData:q,isLoading:H,error:J}=function(e,t,a,o,r,i){const[{uiSettings:n},{data:h},{anomalyDetectorService:g,anomalyExplorerService:f}]=o,{timefilter:p}=h.query.timefilter,[v,x]=Object(s.useState)(),[y,S]=Object(s.useState)(),[E,T]=Object(s.useState)(!1),M=Object(s.useMemo)((()=>new c.Subject),[]),A=Object(s.useMemo)((()=>new c.Subject),[]),w=Object(s.useMemo)((()=>new d.a({"histogram:maxBars":n.get(u.UI_SETTINGS.HISTOGRAM_MAX_BARS),"histogram:barTarget":n.get(u.UI_SETTINGS.HISTOGRAM_BAR_TARGET),dateFormat:n.get("dateFormat"),"dateFormat:scaled":n.get("dateFormat:scaled")})),[]);return Object(s.useEffect)((()=>{const t=Object(c.combineLatest)([Object(O.a)(e,g,S),e,M.pipe(Object(l.skipWhile)((e=>!e))),A,a.pipe(Object(l.startWith)(null))]).pipe(Object(l.tap)(T.bind(null,!0)),Object(l.debounceTime)(500),Object(l.switchMap)((([e,t,a,s])=>{var o,r;if(!e)return Object(c.of)(void 0);const{maxSeriesToPlot:i,timeRange:n,filters:d,query:u}=t,O=m.g;let h;f.setTimeRange(n);try{h=Object(j.a)(d,u)}catch(e){return S(e),Object(c.of)(void 0)}const g=f.getTimeBounds(),v={lanes:[m.g],times:[null===(o=g.min)||void 0===o?void 0:o.unix(),null===(r=g.max)||void 0===r?void 0:r.unix()],type:m.h.OVERALL},x=Object(b.i)(v,O),y=Object(b.j)(v,e),E=w.getInterval(),T=Object(b.k)(v,E.asSeconds(),g);return Object(c.forkJoin)({combinedJobs:f.getCombinedJobs(y),anomalyChartRecords:f.loadDataForCharts$(y,T.earliestMs,T.latestMs,x,v,h)}).pipe(Object(l.switchMap)((({combinedJobs:e,anomalyChartRecords:t})=>{const o=e.reduce(((e,t)=>({...e,[t.job_id]:t})),{});return Object(c.forkJoin)({chartsData:Object(c.from)(f.getAnomalyData(void 0,o,a,t,T.earliestMs,T.latestMs,p,s,i))})})))})),Object(l.catchError)((e=>(S(e.body),Object(c.of)(void 0))))).subscribe((e=>{void 0!==e&&(S(null),x(e.chartsData),T(!1))}));return()=>{t.unsubscribe()}}),[]),Object(s.useEffect)((()=>{M.next(r)}),[r]),Object(s.useEffect)((()=>{A.next(i)}),[i]),{chartsData:v,isLoading:E,error:y}}(a,0,h,o,y,I.val),U=Object(s.useCallback)(Object(n.throttle)((e=>{Math.abs(y-e.width)>20&&w(e.width)}),500),[y]);if(J)return Object(x.jsx)(r.EuiCallOut,{title:Object(x.jsx)(i.FormattedMessage,{id:"xpack.ml.anomalyChartsEmbeddable.errorMessage",defaultMessage:"Unable to load the ML anomaly explorer data"}),color:"danger",iconType:"alert",style:{width:"100%"}},Object(x.jsx)("p",null,J.message));const z=(e,a,s)=>{const o=[{fieldName:e,fieldValue:a,operation:s}];R(o),L.getTrigger(A.a).exec({embeddable:t,data:o})};return Object(x.jsx)(r.EuiResizeObserver,{onResize:U},(a=>Object(x.jsx)("div",{id:`mlAnomalyExplorerEmbeddableWrapper-${e}`,style:{width:"100%",overflowY:"auto",overflowX:"hidden",padding:"8px"},"data-test-subj":`mlExplorerEmbeddable_${t.id}`,ref:a},H&&Object(x.jsx)(r.EuiText,{textAlign:"center",style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)"}},Object(x.jsx)(r.EuiLoadingChart,{size:"xl",mono:!0,"data-test-subj":"mlAnomalyExplorerEmbeddableLoadingIndicator"})),void 0!==q&&!1===H&&Object(x.jsx)(S,{id:e,showCharts:!0,chartsData:q,severity:I,setSeverity:_,mlLocator:D,timeBuckets:N,timefilter:G,onSelectEntity:z,showSelectedInterval:!1}))))};t.default=w}}]);